[root@VM-0-31-centos iks]# cd /etc/iks && ./iksctl setup all
ansible-playbook -i hosts playbooks/9.all.yml
2022-12-21 14:05:34 INFO  setup step:all begins in 5s, press any key to abort:


PLAY [0.系统初始化] *****************************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************************
ok: [172.21.0.31]
ok: [172.21.0.41]
ok: [172.21.0.35]

TASK [preinstall : 资源检测] *******************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.41]
changed: [172.21.0.35]

TASK [preinstall : set sshd_config] ********************************************************************************************************************************
ok: [172.21.0.35] => (item={u'regexp': u'#UseDNS yes', u'replace': u'UseDNS no'})
ok: [172.21.0.31] => (item={u'regexp': u'#UseDNS yes', u'replace': u'UseDNS no'})
ok: [172.21.0.41] => (item={u'regexp': u'#UseDNS yes', u'replace': u'UseDNS no'})
changed: [172.21.0.41] => (item={u'regexp': u'GSSAPIAuthentication yes', u'replace': u'GSSAPIAuthentication no'})
changed: [172.21.0.35] => (item={u'regexp': u'GSSAPIAuthentication yes', u'replace': u'GSSAPIAuthentication no'})
changed: [172.21.0.31] => (item={u'regexp': u'GSSAPIAuthentication yes', u'replace': u'GSSAPIAuthentication no'})

TASK [preinstall : 准备软件安装包目录] **************************************************************************************************************************************
changed: [172.21.0.41]
changed: [172.21.0.35]
ok: [172.21.0.31]

TASK [preinstall : 判断k8s软件包是否存在] ***********************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [preinstall : 分发k8s安装包] ***************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.41]
changed: [172.21.0.35]

TASK [preinstall : 解压k8s安装包] ***************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [preinstall : 分发prometheus镜像包] ********************************************************************************************************************************
changed: [172.21.0.31]

TASK [preinstall : symlink /usr/bin/python -> /usr/bin/python3] ****************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [preinstall : 获取ansible服务端ip] *********************************************************************************************************************************
changed: [172.21.0.31]

TASK [preinstall : 设置变量 LOCAL_IP] **********************************************************************************************************************************
ok: [172.21.0.31]

TASK [preinstall : debug info] *************************************************************************************************************************************
ok: [172.21.0.31] => {
    "LOCAL_IP": "172.21.0.31"
}

TASK [preinstall : 分区格式化] ******************************************************************************************************************************************
changed: [172.21.0.41]
changed: [172.21.0.31]
changed: [172.21.0.35]

TASK [preinstall : Disable and stop system service] ****************************************************************************************************************
ok: [172.21.0.31] => (item=NetworkManager)
ok: [172.21.0.41] => (item=NetworkManager)
ok: [172.21.0.35] => (item=NetworkManager)
ok: [172.21.0.31] => (item=firewalld)
ok: [172.21.0.41] => (item=firewalld)
ok: [172.21.0.35] => (item=firewalld)
ok: [172.21.0.41] => (item=postfix)
ok: [172.21.0.35] => (item=postfix)
ok: [172.21.0.31] => (item=postfix)
failed: [172.21.0.41] (item=chronyd) => {"ansible_loop_var": "item", "changed": false, "item": "chronyd", "msg": "Could not find the requested service chronyd: host"}
failed: [172.21.0.35] (item=chronyd) => {"ansible_loop_var": "item", "changed": false, "item": "chronyd", "msg": "Could not find the requested service chronyd: host"}
failed: [172.21.0.31] (item=chronyd) => {"ansible_loop_var": "item", "changed": false, "item": "chronyd", "msg": "Could not find the requested service chronyd: host"}
failed: [172.21.0.41] (item=ntp) => {"ansible_loop_var": "item", "changed": false, "item": "ntp", "msg": "Could not find the requested service ntp: host"}
...ignoring
failed: [172.21.0.35] (item=ntp) => {"ansible_loop_var": "item", "changed": false, "item": "ntp", "msg": "Could not find the requested service ntp: host"}
...ignoring
failed: [172.21.0.31] (item=ntp) => {"ansible_loop_var": "item", "changed": false, "item": "ntp", "msg": "Could not find the requested service ntp: host"}
...ignoring

TASK [preinstall : 判断是否更新过repo] ************************************************************************************************************************************
fatal: [172.21.0.31]: FAILED! => {"changed": true, "cmd": "grep tsinghua /etc/yum.repos.d/os.repo", "delta": "0:00:00.012279", "end": "2022-12-21 14:06:50.524966", "msg": "non-zero return code", "rc": 2, "start": "2022-12-21 14:06:50.512687", "stderr": "grep: /etc/yum.repos.d/os.repo: 没有那个文件或目录", "stderr_lines": ["grep: /etc/yum.repos.d/os.repo: 没有那个文件或目录"], "stdout": "", "stdout_lines": []}
...ignoring
fatal: [172.21.0.41]: FAILED! => {"changed": true, "cmd": "grep tsinghua /etc/yum.repos.d/os.repo", "delta": "0:00:00.011841", "end": "2022-12-21 14:06:50.540725", "msg": "non-zero return code", "rc": 2, "start": "2022-12-21 14:06:50.528884", "stderr": "grep: /etc/yum.repos.d/os.repo: 没有那个文件或目录", "stderr_lines": ["grep: /etc/yum.repos.d/os.repo: 没有那个文件或目录"], "stdout": "", "stdout_lines": []}
...ignoring
fatal: [172.21.0.35]: FAILED! => {"changed": true, "cmd": "grep tsinghua /etc/yum.repos.d/os.repo", "delta": "0:00:01.012684", "end": "2022-12-21 14:06:51.536427", "msg": "non-zero return code", "rc": 2, "start": "2022-12-21 14:06:50.523743", "stderr": "grep: /etc/yum.repos.d/os.repo: 没有那个文件或目录", "stderr_lines": ["grep: /etc/yum.repos.d/os.repo: 没有那个文件或目录"], "stdout": "", "stdout_lines": []}
...ignoring

TASK [preinstall : 判断是否安装了基础软件] ************************************************************************************************************************************
fatal: [172.21.0.41]: FAILED! => {"changed": true, "cmd": "type ipvsadm >/dev/null 2>&1", "delta": "0:00:00.011003", "end": "2022-12-21 14:06:51.905018", "msg": "non-zero return code", "rc": 1, "start": "2022-12-21 14:06:51.894015", "stderr": "", "stderr_lines": [], "stdout": "", "stdout_lines": []}
...ignoring
fatal: [172.21.0.31]: FAILED! => {"changed": true, "cmd": "type ipvsadm >/dev/null 2>&1", "delta": "0:00:00.011543", "end": "2022-12-21 14:06:51.906675", "msg": "non-zero return code", "rc": 1, "start": "2022-12-21 14:06:51.895132", "stderr": "", "stderr_lines": [], "stdout": "", "stdout_lines": []}
...ignoring
fatal: [172.21.0.35]: FAILED! => {"changed": true, "cmd": "type ipvsadm >/dev/null 2>&1", "delta": "0:00:00.011416", "end": "2022-12-21 14:06:51.913335", "msg": "non-zero return code", "rc": 1, "start": "2022-12-21 14:06:51.901919", "stderr": "", "stderr_lines": [], "stdout": "", "stdout_lines": []}
...ignoring

TASK [preinstall : 临时关闭 selinux] ***********************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [preinstall : 永久关闭 selinux] ***********************************************************************************************************************************
ok: [172.21.0.31]
ok: [172.21.0.35]
ok: [172.21.0.41]

TASK [preinstall : 禁止rsyslog获取journald日志1] *************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]
changed: [172.21.0.31]

TASK [preinstall : 禁止rsyslog获取journald日志2] *************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [preinstall : 重启rsyslog服务] ************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.41]
changed: [172.21.0.35]

TASK [preinstall : 分发basic离线包] *************************************************************************************************************************************
ok: [172.21.0.31]
changed: [172.21.0.41]
changed: [172.21.0.35]

TASK [preinstall : 安装centos7基础软件] **********************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]
changed: [172.21.0.31]

TASK [preinstall : Get Kernel version] *****************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [preinstall : debug] ******************************************************************************************************************************************
ok: [172.21.0.31] => {
    "msg": "3.10"
}
ok: [172.21.0.35] => {
    "msg": "3.10"
}
ok: [172.21.0.41] => {
    "msg": "3.10"
}

TASK [preinstall : 1. 分发kernel离线包] *********************************************************************************************************************************
ok: [172.21.0.31]
changed: [172.21.0.41]
changed: [172.21.0.35]

TASK [preinstall : 2. 安装kernel_centos7离线包] *************************************************************************************************************************
changed: [172.21.0.41]
changed: [172.21.0.35]
changed: [172.21.0.31]

TASK [preinstall : 3. 更新内核启动顺序] ************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [preinstall : 4. 重建 grub 引导] **********************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]
changed: [172.21.0.31]

TASK [preinstall : 5. 重启主机] ****************************************************************************************************************************************
changed: [172.21.0.41]
changed: [172.21.0.35]
Connection to 172.21.0.31 closed by remote host.
Connection to 172.21.0.31 closed.
[root@tcs-172-21-0-40 ~]#
[root@tcs-172-21-0-40 ~]# ssh root@172.21.0.31
root@172.21.0.31's password:
Last login: Wed Dec 21 14:09:48 2022 from 172.21.0.31
[root@VM-0-31-centos ~]#
[root@VM-0-31-centos ~]#
[root@VM-0-31-centos ~]# cd /etc/iks && ./iksctl setup all
ansible-playbook -i hosts playbooks/9.all.yml
2022-12-21 14:14:06 INFO  setup step:all begins in 5s, press any key to abort:


PLAY [0.系统初始化] *****************************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************************
ok: [172.21.0.31]
ok: [172.21.0.35]
ok: [172.21.0.41]

TASK [preinstall : 资源检测] *******************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [preinstall : set sshd_config] ********************************************************************************************************************************
ok: [172.21.0.41] => (item={u'regexp': u'#UseDNS yes', u'replace': u'UseDNS no'})
ok: [172.21.0.35] => (item={u'regexp': u'#UseDNS yes', u'replace': u'UseDNS no'})
ok: [172.21.0.31] => (item={u'regexp': u'#UseDNS yes', u'replace': u'UseDNS no'})
ok: [172.21.0.41] => (item={u'regexp': u'GSSAPIAuthentication yes', u'replace': u'GSSAPIAuthentication no'})
ok: [172.21.0.35] => (item={u'regexp': u'GSSAPIAuthentication yes', u'replace': u'GSSAPIAuthentication no'})
ok: [172.21.0.31] => (item={u'regexp': u'GSSAPIAuthentication yes', u'replace': u'GSSAPIAuthentication no'})

TASK [preinstall : 准备软件安装包目录] **************************************************************************************************************************************
ok: [172.21.0.35]
ok: [172.21.0.41]
ok: [172.21.0.31]

TASK [preinstall : 判断k8s软件包是否存在] ***********************************************************************************************************************************
changed: [172.21.0.41]
changed: [172.21.0.35]
changed: [172.21.0.31]

TASK [preinstall : 分发prometheus镜像包] ********************************************************************************************************************************
ok: [172.21.0.31]

TASK [preinstall : symlink /usr/bin/python -> /usr/bin/python3] ****************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [preinstall : 获取ansible服务端ip] *********************************************************************************************************************************
changed: [172.21.0.31]

TASK [preinstall : 设置变量 LOCAL_IP] **********************************************************************************************************************************
ok: [172.21.0.31]

TASK [preinstall : debug info] *************************************************************************************************************************************
ok: [172.21.0.31] => {
    "LOCAL_IP": "172.21.0.31"
}

TASK [preinstall : 分区格式化] ******************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [preinstall : Disable and stop system service] ****************************************************************************************************************
ok: [172.21.0.35] => (item=NetworkManager)
ok: [172.21.0.41] => (item=NetworkManager)
ok: [172.21.0.31] => (item=NetworkManager)
ok: [172.21.0.35] => (item=firewalld)
ok: [172.21.0.41] => (item=firewalld)
ok: [172.21.0.31] => (item=firewalld)
ok: [172.21.0.35] => (item=postfix)
ok: [172.21.0.41] => (item=postfix)
ok: [172.21.0.31] => (item=postfix)
failed: [172.21.0.35] (item=chronyd) => {"ansible_loop_var": "item", "changed": false, "item": "chronyd", "msg": "Could not find the requested service chronyd: host"}
failed: [172.21.0.41] (item=chronyd) => {"ansible_loop_var": "item", "changed": false, "item": "chronyd", "msg": "Could not find the requested service chronyd: host"}
failed: [172.21.0.31] (item=chronyd) => {"ansible_loop_var": "item", "changed": false, "item": "chronyd", "msg": "Could not find the requested service chronyd: host"}
failed: [172.21.0.35] (item=ntp) => {"ansible_loop_var": "item", "changed": false, "item": "ntp", "msg": "Could not find the requested service ntp: host"}
...ignoring
failed: [172.21.0.41] (item=ntp) => {"ansible_loop_var": "item", "changed": false, "item": "ntp", "msg": "Could not find the requested service ntp: host"}
...ignoring
failed: [172.21.0.31] (item=ntp) => {"ansible_loop_var": "item", "changed": false, "item": "ntp", "msg": "Could not find the requested service ntp: host"}
...ignoring

TASK [preinstall : 判断是否更新过repo] ************************************************************************************************************************************
fatal: [172.21.0.35]: FAILED! => {"changed": true, "cmd": "grep tsinghua /etc/yum.repos.d/os.repo", "delta": "0:00:00.012286", "end": "2022-12-21 14:14:28.834766", "msg": "non-zero return code", "rc": 2, "start": "2022-12-21 14:14:28.822480", "stderr": "grep: /etc/yum.repos.d/os.repo: 没有那个文件或目录", "stderr_lines": ["grep: /etc/yum.repos.d/os.repo: 没有那个文件或目录"], "stdout": "", "stdout_lines": []}
...ignoring
fatal: [172.21.0.31]: FAILED! => {"changed": true, "cmd": "grep tsinghua /etc/yum.repos.d/os.repo", "delta": "0:00:00.012123", "end": "2022-12-21 14:14:28.840633", "msg": "non-zero return code", "rc": 2, "start": "2022-12-21 14:14:28.828510", "stderr": "grep: /etc/yum.repos.d/os.repo: 没有那个文件或目录", "stderr_lines": ["grep: /etc/yum.repos.d/os.repo: 没有那个文件或目录"], "stdout": "", "stdout_lines": []}
...ignoring
fatal: [172.21.0.41]: FAILED! => {"changed": true, "cmd": "grep tsinghua /etc/yum.repos.d/os.repo", "delta": "0:00:00.011765", "end": "2022-12-21 14:14:28.851649", "msg": "non-zero return code", "rc": 2, "start": "2022-12-21 14:14:28.839884", "stderr": "grep: /etc/yum.repos.d/os.repo: 没有那个文件或目录", "stderr_lines": ["grep: /etc/yum.repos.d/os.repo: 没有那个文件或目录"], "stdout": "", "stdout_lines": []}
...ignoring

TASK [preinstall : 判断是否安装了基础软件] ************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [preinstall : 临时关闭 selinux] ***********************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [preinstall : 永久关闭 selinux] ***********************************************************************************************************************************
ok: [172.21.0.35]
ok: [172.21.0.31]
ok: [172.21.0.41]

TASK [preinstall : 禁止rsyslog获取journald日志1] *************************************************************************************************************************
ok: [172.21.0.31]
ok: [172.21.0.35]
ok: [172.21.0.41]

TASK [preinstall : 禁止rsyslog获取journald日志2] *************************************************************************************************************************
ok: [172.21.0.31]
ok: [172.21.0.35]
ok: [172.21.0.41]

TASK [preinstall : 重启rsyslog服务] ************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [preinstall : Get Kernel version] *****************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [preinstall : debug] ******************************************************************************************************************************************
ok: [172.21.0.31] => {
    "msg": "5.4"
}
ok: [172.21.0.35] => {
    "msg": "5.4"
}
ok: [172.21.0.41] => {
    "msg": "5.4"
}

TASK [common : 设置 hostname] ****************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]
changed: [172.21.0.31]

TASK [common : 增加 k8s 用户] ******************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]
changed: [172.21.0.31]

TASK [common : 设置k8s 用户具有sudo权限] ***********************************************************************************************************************************
changed: [172.21.0.31] => (item=k8s ALL=(ALL) NOPASSWD: ALL)
changed: [172.21.0.35] => (item=k8s ALL=(ALL) NOPASSWD: ALL)
changed: [172.21.0.41] => (item=k8s ALL=(ALL) NOPASSWD: ALL)

TASK [common : 关闭 swapoff] *****************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [common : 修改fstab swap 相关配置] **********************************************************************************************************************************
ok: [172.21.0.35]
ok: [172.21.0.41]
ok: [172.21.0.31]

TASK [common : 加载内核模块] *********************************************************************************************************************************************
changed: [172.21.0.41] => (item=br_netfilter)
changed: [172.21.0.35] => (item=br_netfilter)
changed: [172.21.0.31] => (item=br_netfilter)
changed: [172.21.0.41] => (item=ip_vs)
changed: [172.21.0.35] => (item=ip_vs)
changed: [172.21.0.31] => (item=ip_vs)
changed: [172.21.0.41] => (item=ip_vs_rr)
changed: [172.21.0.35] => (item=ip_vs_rr)
changed: [172.21.0.31] => (item=ip_vs_rr)
changed: [172.21.0.35] => (item=ip_vs_wrr)
changed: [172.21.0.41] => (item=ip_vs_wrr)
changed: [172.21.0.31] => (item=ip_vs_wrr)
changed: [172.21.0.41] => (item=ip_vs_sh)
changed: [172.21.0.35] => (item=ip_vs_sh)
changed: [172.21.0.31] => (item=ip_vs_sh)
ok: [172.21.0.41] => (item=nf_conntrack)
ok: [172.21.0.35] => (item=nf_conntrack)
ok: [172.21.0.31] => (item=nf_conntrack)

TASK [common : 拷贝内核模块] *********************************************************************************************************************************************
changed: [172.21.0.41]
changed: [172.21.0.31]
changed: [172.21.0.35]

TASK [common : 启用systemd自动加载模块服务] **********************************************************************************************************************************
ok: [172.21.0.31]
ok: [172.21.0.35]
ok: [172.21.0.41]

TASK [common : 设置系统参数] *********************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [common : 生效系统参数] *********************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [common : 创建 systemd 配置目录] ************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [common : 设置系统 ulimits] ***************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [common : 把SCTP列入内核模块黑名单] *************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [common : 创建kube目录] *******************************************************************************************************************************************
changed: [172.21.0.31] => (item=/root/.kube)
changed: [172.21.0.35] => (item=/root/.kube)
changed: [172.21.0.41] => (item=/root/.kube)

TASK [common : 配置/etc/profile] *************************************************************************************************************************************
changed: [172.21.0.31] => (item=export HISTTIMEFORMAT="%F %T `whoami` ")
changed: [172.21.0.35] => (item=export HISTTIMEFORMAT="%F %T `whoami` ")
changed: [172.21.0.41] => (item=export HISTTIMEFORMAT="%F %T `whoami` ")
changed: [172.21.0.31] => (item=export HISTSIZE=10240)
changed: [172.21.0.35] => (item=export HISTSIZE=10240)
changed: [172.21.0.41] => (item=export HISTSIZE=10240)

TASK [common : 写入环境变量$PATH] ****************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [common : 添加 kubectl 命令自动补全] **********************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [chrony : prepare some dirs] **********************************************************************************************************************************
changed: [172.21.0.31] => (item=/etc/chrony)
changed: [172.21.0.35] => (item=/etc/chrony)
changed: [172.21.0.41] => (item=/etc/chrony)
changed: [172.21.0.35] => (item=/var/lib/chrony)
changed: [172.21.0.31] => (item=/var/lib/chrony)
changed: [172.21.0.41] => (item=/var/lib/chrony)
changed: [172.21.0.35] => (item=/var/log/chrony)
changed: [172.21.0.41] => (item=/var/log/chrony)
changed: [172.21.0.31] => (item=/var/log/chrony)

TASK [拷贝二进制文件chronyd] **********************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [创建chronyd的systemd unit文件] ************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [配置 chrony server] ********************************************************************************************************************************************
changed: [172.21.0.31]

TASK [配置 chrony client] ********************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [开机启用chronyd服务] ***********************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [开启chronyd服务] *************************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [以轮询的方式等待chronyd服务启动] *****************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

PLAY [1.自签证书] ******************************************************************************************************************************************************

TASK [deploy : 删除工作目录] *********************************************************************************************************************************************
ok: [localhost]

TASK [deploy : 创建工作目录] *********************************************************************************************************************************************
changed: [localhost] => (item=ssl)
changed: [localhost] => (item=yaml)

TASK [deploy : 准备CA证书签名请求] *****************************************************************************************************************************************
changed: [localhost] => (item=ca-config.json)
changed: [localhost] => (item=ca-csr.json)

TASK [deploy : 生成 CA 证书和私钥] ****************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 准备 master证书签名请求] ************************************************************************************************************************************
changed: [localhost] => (item=admin-csr.json)
changed: [localhost] => (item=kube-scheduler-csr.json)
changed: [localhost] => (item=kube-controller-manager-csr.json)
changed: [localhost] => (item=kube-proxy-csr.json)
changed: [localhost] => (item=aggregator-proxy-csr.json)

TASK [deploy : 创建 master证书与私钥] *************************************************************************************************************************************
changed: [localhost] => (item=admin)
changed: [localhost] => (item=kube-scheduler)
changed: [localhost] => (item=kube-controller-manager)
changed: [localhost] => (item=kube-proxy)
changed: [localhost] => (item=aggregator-proxy)

TASK [deploy : 设置集群参数] *********************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 设置客户端认证参数] ******************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 设置上下文参数] ********************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 选择默认上下文] ********************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 设置集群参数] *********************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 设置客户端认证参数] ******************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 设置上下文参数] ********************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 选择默认上下文] ********************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 设置集群参数] *********************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 设置认证参数] *********************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 设置上下文参数] ********************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 选择默认上下文] ********************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 设置集群参数] *********************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 设置认证参数] *********************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 设置上下文参数] ********************************************************************************************************************************************
changed: [localhost]

TASK [deploy : 选择默认上下文] ********************************************************************************************************************************************
changed: [localhost]

PLAY [2.部署ETCD集群] **************************************************************************************************************************************************

TASK [etcd : 停止服务] *************************************************************************************************************************************************
fatal: [172.21.0.41]: FAILED! => {"changed": false, "msg": "Could not find the requested service etcd: host"}
...ignoring
fatal: [172.21.0.35]: FAILED! => {"changed": false, "msg": "Could not find the requested service etcd: host"}
...ignoring
fatal: [172.21.0.31]: FAILED! => {"changed": false, "msg": "Could not find the requested service etcd: host"}
...ignoring

TASK [etcd : 删除工作目录] ***********************************************************************************************************************************************
ok: [172.21.0.31]
ok: [172.21.0.35]
ok: [172.21.0.41]

TASK [etcd : 创建工作目录] ***********************************************************************************************************************************************
changed: [172.21.0.31] => (item=conf)
changed: [172.21.0.35] => (item=conf)
changed: [172.21.0.41] => (item=conf)
changed: [172.21.0.31] => (item=cert)
changed: [172.21.0.35] => (item=cert)
changed: [172.21.0.41] => (item=cert)
changed: [172.21.0.35] => (item=data)
changed: [172.21.0.41] => (item=data)
changed: [172.21.0.31] => (item=data)

TASK [准备 etcd证书签名请求] ***********************************************************************************************************************************************
changed: [172.21.0.31]
ok: [172.21.0.35]
ok: [172.21.0.41]

TASK [创建 etcd证书与私钥] ************************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]
changed: [172.21.0.31]

TASK [etcd : 分发证书相关] ***********************************************************************************************************************************************
changed: [172.21.0.35] => (item=ca.pem)
changed: [172.21.0.41] => (item=ca.pem)
changed: [172.21.0.31] => (item=ca.pem)
changed: [172.21.0.41] => (item=etcd.pem)
changed: [172.21.0.35] => (item=etcd.pem)
changed: [172.21.0.31] => (item=etcd.pem)
changed: [172.21.0.41] => (item=etcd-key.pem)
changed: [172.21.0.35] => (item=etcd-key.pem)
changed: [172.21.0.31] => (item=etcd-key.pem)

TASK [分发etcd配置文件] **************************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [etcd : 分发service文件] ******************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [启动etcd] ******************************************************************************************************************************************************
changed: [172.21.0.41]
changed: [172.21.0.35]
changed: [172.21.0.31]

TASK [分发etcd脚本] ****************************************************************************************************************************************************
changed: [172.21.0.31]

TASK [获取etcd集群状态] **************************************************************************************************************************************************
changed: [172.21.0.31]

TASK [etcd : debug] ************************************************************************************************************************************************
ok: [172.21.0.31] => {
    "status.stdout_lines": [
        "+--------------------------+--------+-------------+-------+",
        "|         ENDPOINT         | HEALTH |    TOOK     | ERROR |",
        "+--------------------------+--------+-------------+-------+",
        "| https://172.21.0.31:2379 |   true |  8.093341ms |       |",
        "| https://172.21.0.35:2379 |   true |  8.391449ms |       |",
        "| https://172.21.0.41:2379 |   true | 11.670192ms |       |",
        "+--------------------------+--------+-------------+-------+",
        "+--------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+",
        "|         ENDPOINT         |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |",
        "+--------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+",
        "| https://172.21.0.31:2379 |   be7415a3880508 |   3.5.5 |   20 kB |      true |      false |         2 |         11 |                 11 |        |",
        "| https://172.21.0.35:2379 | 45660c120b89f380 |   3.5.5 |   20 kB |     false |      false |         2 |         11 |                 11 |        |",
        "| https://172.21.0.41:2379 | 623bda8667b43800 |   3.5.5 |   20 kB |     false |      false |         2 |         11 |                 11 |        |",
        "+--------------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+"
    ]
}
ok: [172.21.0.35] => {
    "status.stdout_lines": "VARIABLE IS NOT DEFINED!"
}
ok: [172.21.0.41] => {
    "status.stdout_lines": "VARIABLE IS NOT DEFINED!"
}

PLAY [3.部署runtime] *************************************************************************************************************************************************

TASK [获取是否已经安装containerd] ******************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [containerd : 加载内核模块 overlay br_netfilter] ********************************************************************************************************************
changed: [172.21.0.35] => (item=overlay)
changed: [172.21.0.31] => (item=overlay)
changed: [172.21.0.41] => (item=overlay)
ok: [172.21.0.35] => (item=br_netfilter)
ok: [172.21.0.41] => (item=br_netfilter)
ok: [172.21.0.31] => (item=br_netfilter)

TASK [创建containerd 目录] *********************************************************************************************************************************************
changed: [172.21.0.31] => (item=/etc/containerd)
changed: [172.21.0.35] => (item=/etc/containerd)
changed: [172.21.0.41] => (item=/etc/containerd)
changed: [172.21.0.31] => (item=/data/containerd_data/containerd)
changed: [172.21.0.35] => (item=/data/containerd_data/containerd)
changed: [172.21.0.41] => (item=/data/containerd_data/containerd)

TASK [创建 containerd 配置文件] ******************************************************************************************************************************************
changed: [172.21.0.41]
changed: [172.21.0.35]
changed: [172.21.0.31]

TASK [创建containerd 目录软连接] ******************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [containerd : 创建 crictl 配置] ***********************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [containerd : 创建systemd unit文件] *******************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]
changed: [172.21.0.31]

TASK [开机启用 containerd 服务] ******************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [开启 containerd 服务] ********************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [轮询等待containerd服务运行] ******************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [containerd : 添加 crictl 命令自动补全] *******************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

PLAY [4.部署K8S Master] **********************************************************************************************************************************************

TASK [nginx : 停止服务] ************************************************************************************************************************************************
failed: [172.21.0.35] (item=nginx) => {"ansible_loop_var": "item", "changed": false, "item": "nginx", "msg": "Could not find the requested service nginx: host"}
...ignoring
failed: [172.21.0.41] (item=nginx) => {"ansible_loop_var": "item", "changed": false, "item": "nginx", "msg": "Could not find the requested service nginx: host"}
...ignoring
failed: [172.21.0.31] (item=nginx) => {"ansible_loop_var": "item", "changed": false, "item": "nginx", "msg": "Could not find the requested service nginx: host"}
...ignoring

TASK [nginx : 删除目录] ************************************************************************************************************************************************
ok: [172.21.0.31] => (item=/usr/local/nginx)
ok: [172.21.0.35] => (item=/usr/local/nginx)
ok: [172.21.0.41] => (item=/usr/local/nginx)

TASK [解压nginx安装包] **************************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.41]
changed: [172.21.0.35]

TASK [拷贝nginx配置文件] *************************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [拷贝nginx 服务文件] ************************************************************************************************************************************************
changed: [172.21.0.41] => (item=nginx.service.j2)
changed: [172.21.0.35] => (item=nginx.service.j2)
changed: [172.21.0.31] => (item=nginx.service.j2)

TASK [nginx : 启动服务] ************************************************************************************************************************************************
changed: [172.21.0.31] => (item=nginx)
changed: [172.21.0.41] => (item=nginx)
changed: [172.21.0.35] => (item=nginx)

TASK [轮询等待nginx启动] *************************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.41]
changed: [172.21.0.35]

TASK [master : 停止服务] ***********************************************************************************************************************************************
failed: [172.21.0.31] (item=kube-apiserver) => {"ansible_loop_var": "item", "changed": false, "item": "kube-apiserver", "msg": "Could not find the requested service kube-apiserver: host"}
failed: [172.21.0.35] (item=kube-apiserver) => {"ansible_loop_var": "item", "changed": false, "item": "kube-apiserver", "msg": "Could not find the requested service kube-apiserver: host"}
failed: [172.21.0.41] (item=kube-apiserver) => {"ansible_loop_var": "item", "changed": false, "item": "kube-apiserver", "msg": "Could not find the requested service kube-apiserver: host"}
failed: [172.21.0.31] (item=kube-controller-manager) => {"ansible_loop_var": "item", "changed": false, "item": "kube-controller-manager", "msg": "Could not find the requested service kube-controller-manager: host"}
failed: [172.21.0.35] (item=kube-controller-manager) => {"ansible_loop_var": "item", "changed": false, "item": "kube-controller-manager", "msg": "Could not find the requested service kube-controller-manager: host"}
failed: [172.21.0.41] (item=kube-controller-manager) => {"ansible_loop_var": "item", "changed": false, "item": "kube-controller-manager", "msg": "Could not find the requested service kube-controller-manager: host"}
failed: [172.21.0.31] (item=kube-scheduler) => {"ansible_loop_var": "item", "changed": false, "item": "kube-scheduler", "msg": "Could not find the requested service kube-scheduler: host"}
...ignoring
failed: [172.21.0.35] (item=kube-scheduler) => {"ansible_loop_var": "item", "changed": false, "item": "kube-scheduler", "msg": "Could not find the requested service kube-scheduler: host"}
...ignoring
failed: [172.21.0.41] (item=kube-scheduler) => {"ansible_loop_var": "item", "changed": false, "item": "kube-scheduler", "msg": "Could not find the requested service kube-scheduler: host"}
...ignoring

TASK [master : 删除工作目录] *********************************************************************************************************************************************
ok: [172.21.0.31] => (item=conf)
ok: [172.21.0.41] => (item=conf)
ok: [172.21.0.35] => (item=conf)
ok: [172.21.0.41] => (item=cert)
ok: [172.21.0.35] => (item=cert)
ok: [172.21.0.31] => (item=cert)

TASK [master : 创建工作目录] *********************************************************************************************************************************************
changed: [172.21.0.35] => (item=conf)
changed: [172.21.0.31] => (item=conf)
changed: [172.21.0.41] => (item=conf)
changed: [172.21.0.35] => (item=cert)
changed: [172.21.0.31] => (item=cert)
changed: [172.21.0.41] => (item=cert)

TASK [master : 删除原有kubeconfig] *************************************************************************************************************************************
ok: [172.21.0.31]
ok: [172.21.0.35]
ok: [172.21.0.41]

TASK [准备 master证书签名请求] *********************************************************************************************************************************************
changed: [172.21.0.35]
ok: [172.21.0.41]
ok: [172.21.0.31]

TASK [创建 master证书与私钥] **********************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.41]
changed: [172.21.0.35]

TASK [master : 分发证书相关] *********************************************************************************************************************************************
changed: [172.21.0.35] => (item=ca.pem)
changed: [172.21.0.41] => (item=ca.pem)
changed: [172.21.0.31] => (item=ca.pem)
changed: [172.21.0.35] => (item=ca-key.pem)
changed: [172.21.0.41] => (item=ca-key.pem)
changed: [172.21.0.31] => (item=ca-key.pem)
changed: [172.21.0.41] => (item=server.pem)
changed: [172.21.0.35] => (item=server.pem)
changed: [172.21.0.31] => (item=server.pem)
changed: [172.21.0.41] => (item=server-key.pem)
changed: [172.21.0.35] => (item=server-key.pem)
changed: [172.21.0.31] => (item=server-key.pem)
changed: [172.21.0.41] => (item=kube-controller-manager.pem)
changed: [172.21.0.35] => (item=kube-controller-manager.pem)
changed: [172.21.0.31] => (item=kube-controller-manager.pem)
changed: [172.21.0.41] => (item=kube-controller-manager-key.pem)
changed: [172.21.0.35] => (item=kube-controller-manager-key.pem)
changed: [172.21.0.31] => (item=kube-controller-manager-key.pem)
changed: [172.21.0.41] => (item=aggregator-proxy.pem)
changed: [172.21.0.35] => (item=aggregator-proxy.pem)
changed: [172.21.0.31] => (item=aggregator-proxy.pem)
changed: [172.21.0.41] => (item=aggregator-proxy-key.pem)
changed: [172.21.0.35] => (item=aggregator-proxy-key.pem)
changed: [172.21.0.31] => (item=aggregator-proxy-key.pem)

TASK [master : 分发k8s配置文件] ******************************************************************************************************************************************
changed: [172.21.0.31] => (item=kube-apiserver.conf.j2)
changed: [172.21.0.35] => (item=kube-apiserver.conf.j2)
changed: [172.21.0.41] => (item=kube-apiserver.conf.j2)
changed: [172.21.0.35] => (item=kube-controller-manager.conf.j2)
changed: [172.21.0.31] => (item=kube-controller-manager.conf.j2)
changed: [172.21.0.41] => (item=kube-controller-manager.conf.j2)
changed: [172.21.0.41] => (item=kube-scheduler.conf.j2)
changed: [172.21.0.35] => (item=kube-scheduler.conf.j2)
changed: [172.21.0.31] => (item=kube-scheduler.conf.j2)

TASK [master : 分发 kubeconfig配置文件] **********************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]
changed: [172.21.0.31]

TASK [master : 分发controller/scheduler kubeconfig配置文件] **************************************************************************************************************
changed: [172.21.0.41] => (item=kube-controller-manager.kubeconfig)
changed: [172.21.0.35] => (item=kube-controller-manager.kubeconfig)
changed: [172.21.0.31] => (item=kube-controller-manager.kubeconfig)
changed: [172.21.0.41] => (item=kube-scheduler.kubeconfig)
changed: [172.21.0.35] => (item=kube-scheduler.kubeconfig)
changed: [172.21.0.31] => (item=kube-scheduler.kubeconfig)

TASK [master : 分发service文件] ****************************************************************************************************************************************
changed: [172.21.0.35] => (item=kube-apiserver.service.j2)
changed: [172.21.0.31] => (item=kube-apiserver.service.j2)
changed: [172.21.0.41] => (item=kube-apiserver.service.j2)
changed: [172.21.0.35] => (item=kube-controller-manager.service.j2)
changed: [172.21.0.41] => (item=kube-controller-manager.service.j2)
changed: [172.21.0.31] => (item=kube-controller-manager.service.j2)
changed: [172.21.0.35] => (item=kube-scheduler.service.j2)
changed: [172.21.0.41] => (item=kube-scheduler.service.j2)
changed: [172.21.0.31] => (item=kube-scheduler.service.j2)

TASK [启动k8s master组件] **********************************************************************************************************************************************
changed: [172.21.0.31] => (item=kube-apiserver)
changed: [172.21.0.35] => (item=kube-apiserver)
changed: [172.21.0.41] => (item=kube-apiserver)
changed: [172.21.0.31] => (item=kube-controller-manager)
changed: [172.21.0.41] => (item=kube-controller-manager)
changed: [172.21.0.35] => (item=kube-controller-manager)
changed: [172.21.0.35] => (item=kube-scheduler)
changed: [172.21.0.41] => (item=kube-scheduler)
changed: [172.21.0.31] => (item=kube-scheduler)

TASK [master : 轮询等待kube-apiserver启动] *******************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]
changed: [172.21.0.31]

TASK [master : 轮询等待kube-controller-manager启动] **********************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [master : 轮询等待kube-scheduler启动] *******************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [以轮询的方式等待master服务启动完成] ****************************************************************************************************************************************
changed: [172.21.0.41]
changed: [172.21.0.31]
changed: [172.21.0.35]

TASK [master : 获取user:kubernetes是否已经绑定对应角色] ************************************************************************************************************************
changed: [172.21.0.31]

TASK [master : 创建user:kubernetes角色绑定] ******************************************************************************************************************************
changed: [172.21.0.31]

TASK [node : 停止kubelet kube-proxy服务] *******************************************************************************************************************************
failed: [172.21.0.31] (item=kubelet) => {"ansible_loop_var": "item", "changed": false, "item": "kubelet", "msg": "Could not find the requested service kubelet: host"}
failed: [172.21.0.35] (item=kubelet) => {"ansible_loop_var": "item", "changed": false, "item": "kubelet", "msg": "Could not find the requested service kubelet: host"}
failed: [172.21.0.41] (item=kubelet) => {"ansible_loop_var": "item", "changed": false, "item": "kubelet", "msg": "Could not find the requested service kubelet: host"}
failed: [172.21.0.31] (item=kube-proxy) => {"ansible_loop_var": "item", "changed": false, "item": "kube-proxy", "msg": "Could not find the requested service kube-proxy: host"}
...ignoring
failed: [172.21.0.35] (item=kube-proxy) => {"ansible_loop_var": "item", "changed": false, "item": "kube-proxy", "msg": "Could not find the requested service kube-proxy: host"}
...ignoring
failed: [172.21.0.41] (item=kube-proxy) => {"ansible_loop_var": "item", "changed": false, "item": "kube-proxy", "msg": "Could not find the requested service kube-proxy: host"}
...ignoring

TASK [node : 删除kubelet配置] ******************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [node : 创建工作目录] ***********************************************************************************************************************************************
ok: [172.21.0.31] => (item=conf)
ok: [172.21.0.35] => (item=conf)
ok: [172.21.0.41] => (item=conf)
ok: [172.21.0.35] => (item=cert)
ok: [172.21.0.31] => (item=cert)
ok: [172.21.0.41] => (item=cert)
changed: [172.21.0.35] => (item=logs)
changed: [172.21.0.31] => (item=logs)
changed: [172.21.0.41] => (item=logs)

TASK [创建node 相关目录] *************************************************************************************************************************************************
ok: [172.21.0.31] => (item=/etc/cni/net.d)
ok: [172.21.0.35] => (item=/etc/cni/net.d)
ok: [172.21.0.41] => (item=/etc/cni/net.d)
changed: [172.21.0.31] => (item=/var/lib/kubelet)
changed: [172.21.0.35] => (item=/var/lib/kubelet)
changed: [172.21.0.41] => (item=/var/lib/kubelet)

TASK [node : 准备 cni配置文件] *******************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]
changed: [172.21.0.31]

TASK [node : 准备kubelet 证书签名请求] *************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [node : 创建 kubelet 证书与私钥] *************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.41]
changed: [172.21.0.35]

TASK [node : 分发ca 证书] **********************************************************************************************************************************************
ok: [172.21.0.31]
ok: [172.21.0.35]
ok: [172.21.0.41]

TASK [node : 分发kubelet 证书] *****************************************************************************************************************************************
changed: [172.21.0.35] => (item=kubelet.pem)
changed: [172.21.0.31] => (item=kubelet.pem)
changed: [172.21.0.41] => (item=kubelet.pem)
changed: [172.21.0.35] => (item=kubelet-key.pem)
changed: [172.21.0.41] => (item=kubelet-key.pem)
changed: [172.21.0.31] => (item=kubelet-key.pem)

TASK [node : 设置集群参数] ***********************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [node : 设置客户端认证参数] ********************************************************************************************************************************************
changed: [172.21.0.41]
changed: [172.21.0.31]
changed: [172.21.0.35]

TASK [node : 设置上下文参数] **********************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [node : 选择默认上下文] **********************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [node : 分发k8s证书] **********************************************************************************************************************************************
ok: [172.21.0.41] => (item=ca.pem)
ok: [172.21.0.35] => (item=ca.pem)
ok: [172.21.0.31] => (item=ca.pem)
changed: [172.21.0.41] => (item=kube-proxy.pem)
changed: [172.21.0.35] => (item=kube-proxy.pem)
changed: [172.21.0.31] => (item=kube-proxy.pem)
changed: [172.21.0.41] => (item=kube-proxy-key.pem)
changed: [172.21.0.31] => (item=kube-proxy-key.pem)
changed: [172.21.0.35] => (item=kube-proxy-key.pem)

TASK [node : 分发k8s配置文件] ********************************************************************************************************************************************
changed: [172.21.0.35] => (item=kubelet.conf.j2)
changed: [172.21.0.31] => (item=kubelet.conf.j2)
changed: [172.21.0.41] => (item=kubelet.conf.j2)
changed: [172.21.0.35] => (item=kubelet-config.yml.j2)
changed: [172.21.0.41] => (item=kubelet-config.yml.j2)
changed: [172.21.0.31] => (item=kubelet-config.yml.j2)
changed: [172.21.0.35] => (item=kube-proxy.conf.j2)
changed: [172.21.0.41] => (item=kube-proxy.conf.j2)
changed: [172.21.0.31] => (item=kube-proxy.conf.j2)
changed: [172.21.0.35] => (item=kube-proxy-config.yml.j2)
changed: [172.21.0.41] => (item=kube-proxy-config.yml.j2)
changed: [172.21.0.31] => (item=kube-proxy-config.yml.j2)

TASK [node : 分发kube-proxy.kubeconfig配置文件] **************************************************************************************************************************
changed: [172.21.0.41] => (item=kube-proxy.kubeconfig)
changed: [172.21.0.31] => (item=kube-proxy.kubeconfig)
changed: [172.21.0.35] => (item=kube-proxy.kubeconfig)

TASK [node : 分发service文件] ******************************************************************************************************************************************
changed: [172.21.0.35] => (item=kubelet.service.j2)
changed: [172.21.0.31] => (item=kubelet.service.j2)
changed: [172.21.0.41] => (item=kubelet.service.j2)
changed: [172.21.0.35] => (item=kube-proxy.service.j2)
changed: [172.21.0.41] => (item=kube-proxy.service.j2)
changed: [172.21.0.31] => (item=kube-proxy.service.j2)

TASK [启动k8s node组件] ************************************************************************************************************************************************
changed: [172.21.0.31] => (item=kubelet)
changed: [172.21.0.41] => (item=kubelet)
changed: [172.21.0.35] => (item=kubelet)
changed: [172.21.0.41] => (item=kube-proxy)
changed: [172.21.0.35] => (item=kube-proxy)
changed: [172.21.0.31] => (item=kube-proxy)

TASK [node : 轮询等待kube-proxy启动] *************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]
changed: [172.21.0.31]

TASK [node : 轮询等待kubelet启动] ****************************************************************************************************************************************
changed: [172.21.0.41]
changed: [172.21.0.31]
changed: [172.21.0.35]
FAILED - RETRYING: 轮询等待node达到Ready状态 (8 retries left).
FAILED - RETRYING: 轮询等待node达到Ready状态 (8 retries left).
FAILED - RETRYING: 轮询等待node达到Ready状态 (8 retries left).
FAILED - RETRYING: 轮询等待node达到Ready状态 (7 retries left).
FAILED - RETRYING: 轮询等待node达到Ready状态 (7 retries left).
FAILED - RETRYING: 轮询等待node达到Ready状态 (7 retries left).

TASK [轮询等待node达到Ready状态] *******************************************************************************************************************************************
changed: [172.21.0.41]
changed: [172.21.0.31]
changed: [172.21.0.35]

TASK [node : 设置master节点role] ***************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [node : 判断是否存在镜像文件] *******************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [node : 导入镜像] *************************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [node : 导入prometheus镜像] ***************************************************************************************************************************************
changed: [172.21.0.31]

PLAY [5.部署K8S Node] ************************************************************************************************************************************************

TASK [nginx : 停止服务] ************************************************************************************************************************************************
changed: [172.21.0.35] => (item=nginx)
changed: [172.21.0.41] => (item=nginx)
changed: [172.21.0.31] => (item=nginx)

TASK [nginx : 删除目录] ************************************************************************************************************************************************
changed: [172.21.0.31] => (item=/usr/local/nginx)
changed: [172.21.0.35] => (item=/usr/local/nginx)
changed: [172.21.0.41] => (item=/usr/local/nginx)

TASK [解压nginx安装包] **************************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [拷贝nginx配置文件] *************************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.41]
changed: [172.21.0.35]

TASK [拷贝nginx 服务文件] ************************************************************************************************************************************************
ok: [172.21.0.41] => (item=nginx.service.j2)
ok: [172.21.0.31] => (item=nginx.service.j2)
ok: [172.21.0.35] => (item=nginx.service.j2)

TASK [nginx : 启动服务] ************************************************************************************************************************************************
changed: [172.21.0.31] => (item=nginx)
changed: [172.21.0.35] => (item=nginx)
changed: [172.21.0.41] => (item=nginx)

TASK [轮询等待nginx启动] *************************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [node : 停止kubelet kube-proxy服务] *******************************************************************************************************************************
changed: [172.21.0.35] => (item=kubelet)
changed: [172.21.0.41] => (item=kubelet)
changed: [172.21.0.31] => (item=kubelet)
changed: [172.21.0.35] => (item=kube-proxy)
changed: [172.21.0.41] => (item=kube-proxy)
changed: [172.21.0.31] => (item=kube-proxy)

TASK [node : 删除kubelet配置] ******************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]
changed: [172.21.0.31]

TASK [node : 创建工作目录] ***********************************************************************************************************************************************
ok: [172.21.0.31] => (item=conf)
ok: [172.21.0.41] => (item=conf)
ok: [172.21.0.35] => (item=conf)
ok: [172.21.0.41] => (item=cert)
ok: [172.21.0.35] => (item=cert)
ok: [172.21.0.31] => (item=cert)
ok: [172.21.0.41] => (item=logs)
ok: [172.21.0.35] => (item=logs)
ok: [172.21.0.31] => (item=logs)

TASK [创建node 相关目录] *************************************************************************************************************************************************
ok: [172.21.0.31] => (item=/etc/cni/net.d)
ok: [172.21.0.41] => (item=/etc/cni/net.d)
ok: [172.21.0.35] => (item=/etc/cni/net.d)
ok: [172.21.0.31] => (item=/var/lib/kubelet)
ok: [172.21.0.41] => (item=/var/lib/kubelet)
ok: [172.21.0.35] => (item=/var/lib/kubelet)

TASK [node : 准备 cni配置文件] *******************************************************************************************************************************************
ok: [172.21.0.35]
ok: [172.21.0.41]
ok: [172.21.0.31]

TASK [node : 准备kubelet 证书签名请求] *************************************************************************************************************************************
ok: [172.21.0.35]
ok: [172.21.0.31]
ok: [172.21.0.41]

TASK [node : 创建 kubelet 证书与私钥] *************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [node : 分发ca 证书] **********************************************************************************************************************************************
ok: [172.21.0.31]
ok: [172.21.0.35]
ok: [172.21.0.41]

TASK [node : 分发kubelet 证书] *****************************************************************************************************************************************
changed: [172.21.0.35] => (item=kubelet.pem)
changed: [172.21.0.41] => (item=kubelet.pem)
changed: [172.21.0.31] => (item=kubelet.pem)
changed: [172.21.0.41] => (item=kubelet-key.pem)
changed: [172.21.0.35] => (item=kubelet-key.pem)
changed: [172.21.0.31] => (item=kubelet-key.pem)

TASK [node : 设置集群参数] ***********************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]
changed: [172.21.0.31]

TASK [node : 设置客户端认证参数] ********************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [node : 设置上下文参数] **********************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [node : 选择默认上下文] **********************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.41]
changed: [172.21.0.31]

TASK [node : 分发k8s证书] **********************************************************************************************************************************************
ok: [172.21.0.41] => (item=ca.pem)
ok: [172.21.0.35] => (item=ca.pem)
ok: [172.21.0.31] => (item=ca.pem)
ok: [172.21.0.41] => (item=kube-proxy.pem)
ok: [172.21.0.35] => (item=kube-proxy.pem)
ok: [172.21.0.31] => (item=kube-proxy.pem)
ok: [172.21.0.41] => (item=kube-proxy-key.pem)
ok: [172.21.0.35] => (item=kube-proxy-key.pem)
ok: [172.21.0.31] => (item=kube-proxy-key.pem)

TASK [node : 分发k8s配置文件] ********************************************************************************************************************************************
changed: [172.21.0.41] => (item=kubelet.conf.j2)
changed: [172.21.0.35] => (item=kubelet.conf.j2)
changed: [172.21.0.31] => (item=kubelet.conf.j2)
changed: [172.21.0.41] => (item=kubelet-config.yml.j2)
changed: [172.21.0.35] => (item=kubelet-config.yml.j2)
changed: [172.21.0.31] => (item=kubelet-config.yml.j2)
changed: [172.21.0.41] => (item=kube-proxy.conf.j2)
changed: [172.21.0.35] => (item=kube-proxy.conf.j2)
changed: [172.21.0.31] => (item=kube-proxy.conf.j2)
changed: [172.21.0.41] => (item=kube-proxy-config.yml.j2)
changed: [172.21.0.35] => (item=kube-proxy-config.yml.j2)
changed: [172.21.0.31] => (item=kube-proxy-config.yml.j2)

TASK [node : 分发kube-proxy.kubeconfig配置文件] **************************************************************************************************************************
changed: [172.21.0.35] => (item=kube-proxy.kubeconfig)
changed: [172.21.0.41] => (item=kube-proxy.kubeconfig)
changed: [172.21.0.31] => (item=kube-proxy.kubeconfig)

TASK [node : 分发service文件] ******************************************************************************************************************************************
ok: [172.21.0.41] => (item=kubelet.service.j2)
ok: [172.21.0.35] => (item=kubelet.service.j2)
ok: [172.21.0.31] => (item=kubelet.service.j2)
ok: [172.21.0.41] => (item=kube-proxy.service.j2)
ok: [172.21.0.35] => (item=kube-proxy.service.j2)
ok: [172.21.0.31] => (item=kube-proxy.service.j2)

TASK [启动k8s node组件] ************************************************************************************************************************************************
changed: [172.21.0.41] => (item=kubelet)
changed: [172.21.0.35] => (item=kubelet)
changed: [172.21.0.31] => (item=kubelet)
changed: [172.21.0.41] => (item=kube-proxy)
changed: [172.21.0.35] => (item=kube-proxy)
changed: [172.21.0.31] => (item=kube-proxy)

TASK [node : 轮询等待kube-proxy启动] *************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [node : 轮询等待kubelet启动] ****************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [轮询等待node达到Ready状态] *******************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [node : 设置master节点role] ***************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [node : 判断是否存在镜像文件] *******************************************************************************************************************************************
changed: [172.21.0.35]
changed: [172.21.0.31]
changed: [172.21.0.41]

TASK [node : 导入镜像] *************************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [node : 导入prometheus镜像] ***************************************************************************************************************************************
changed: [172.21.0.31]

PLAY [6.部署网络插件] ****************************************************************************************************************************************************

TASK [创建flannel 相关目录] **********************************************************************************************************************************************
ok: [172.21.0.31] => (item=/etc/cni/net.d)
ok: [172.21.0.35] => (item=/etc/cni/net.d)
ok: [172.21.0.41] => (item=/etc/cni/net.d)

TASK [配置 flannel DaemonSet yaml文件] *********************************************************************************************************************************
changed: [172.21.0.31]

TASK [flannel : 删除默认cni配置] *****************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

TASK [运行 flannel网络] ************************************************************************************************************************************************
changed: [172.21.0.31]
FAILED - RETRYING: 轮询等待flannel 运行，视下载镜像速度而定 (15 retries left).
FAILED - RETRYING: 轮询等待flannel 运行，视下载镜像速度而定 (15 retries left).
FAILED - RETRYING: 轮询等待flannel 运行，视下载镜像速度而定 (15 retries left).

TASK [轮询等待flannel 运行，视下载镜像速度而定] ************************************************************************************************************************************
changed: [172.21.0.31]
changed: [172.21.0.35]
changed: [172.21.0.41]

PLAY [7.部署插件] ******************************************************************************************************************************************************

TASK [addons : 获取所有已经创建的POD信息] *************************************************************************************************************************************
changed: [localhost]

TASK [addons : 获取是否已打标签] *******************************************************************************************************************************************
fatal: [localhost]: FAILED! => {"changed": true, "cmd": "/opt/iks/bin/kubectl get no --show-labels|grep prometheus=server", "delta": "0:00:00.051118", "end": "2022-12-21 14:16:19.265044", "msg": "non-zero return code", "rc": 1, "start": "2022-12-21 14:16:19.213926", "stderr": "", "stderr_lines": [], "stdout": "", "stdout_lines": []}
...ignoring

TASK [addons : 给prometheus节点打标签] ***********************************************************************************************************************************
changed: [localhost]

TASK [addons : 准备 DNS的部署文件] ****************************************************************************************************************************************
changed: [localhost]

TASK [addons : 创建coredns部署] ****************************************************************************************************************************************
changed: [localhost]
FAILED - RETRYING: 轮询等待 coredns 运行 (24 retries left).

TASK [addons : 轮询等待 coredns 运行] ************************************************************************************************************************************
changed: [localhost]

TASK [addons : 准备dnscache的部署文件] ************************************************************************************************************************************
changed: [localhost]

TASK [addons : 创建dnscache部署] ***************************************************************************************************************************************
changed: [localhost]
FAILED - RETRYING: 轮询等待 dnscache 运行 (24 retries left).

TASK [addons : 轮询等待 dnscache 运行] ***********************************************************************************************************************************
changed: [localhost]

TASK [addons : 准备metrics-server的部署文件] ******************************************************************************************************************************
changed: [localhost]

TASK [addons : 创建metrics-server部署] *********************************************************************************************************************************
changed: [localhost]
FAILED - RETRYING: 轮询等待 metrics-server 运行 (24 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (23 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (22 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (21 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (20 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (19 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (18 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (17 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (16 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (15 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (14 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (13 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (12 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (11 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (10 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (9 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (8 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (7 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (6 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (5 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (4 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (3 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (2 retries left).
FAILED - RETRYING: 轮询等待 metrics-server 运行 (1 retries left).

TASK [addons : 轮询等待 metrics-server 运行] *****************************************************************************************************************************
fatal: [localhost]: FAILED! => {"attempts": 24, "changed": true, "cmd": "/opt/iks/bin/kubectl get pod --all-namespaces -o wide | grep 'metrics-server' | awk '{print $4}'", "delta": "0:00:00.047229", "end": "2022-12-21 14:18:35.905921", "rc": 0, "start": "2022-12-21 14:18:35.858692", "stderr": "", "stderr_lines": [], "stdout": "ImagePullBackOff", "stdout_lines": ["ImagePullBackOff"]}
...ignoring

TASK [addons : 创建 kubernetes-dashboard 默认证书] ***********************************************************************************************************************
changed: [localhost]

TASK [addons : 获取 kubernetes-dashboard 默认证书] ***********************************************************************************************************************
ok: [localhost] => (item=dashboard.key)
ok: [localhost] => (item=dashboard.crt)

TASK [addons : 准备dashboard的部署文件] ***********************************************************************************************************************************
changed: [localhost] => (item=kubernetes-dashboard.yaml)
changed: [localhost] => (item=ingress-dashboard.yaml)

TASK [addons : 准备dashboard-admin部署文件] ******************************************************************************************************************************
changed: [localhost]

TASK [addons : 创建dashboard部署] **************************************************************************************************************************************
changed: [localhost]

TASK [addons : 准备只读权限用户文件] *****************************************************************************************************************************************
changed: [localhost]

TASK [addons : 创建只读用户] *********************************************************************************************************************************************
changed: [localhost]

TASK [addons : 创建ingress] ******************************************************************************************************************************************
changed: [localhost]

TASK [addons : 获取Dashboard管理员令牌] ***********************************************************************************************************************************
changed: [localhost]

TASK [addons : Kubernetes Dashboard登录信息] ***************************************************************************************************************************
ok: [localhost] => {
    "ui.stdout_lines": [
        "访问地址--->https://172.21.0.31:32020 or https://monitor.yufuid.net/dashboard/",
        "令牌内容--->eyJhbGciOiJSUzI1NiIsImtpZCI6IkVtYjJpbkkxQjRYZENQRkFKak01b0x2ZTJWUlAyLUlCRnROYUl0a1hGd0UifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tc2w3cnoiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMzZjMTJiZWYtNjkzYi00ZmQwLTg2MWQtYjM4ZGE5ZmZiZjc3Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.B7iCgjVmqRzqvzMgXVb-PbcpveXAfRSc2OS6gV85cLoHm1wiG9emRAXknesSVfsiiNerOL69lgnz-sgk1PCW5kGYBsNkYCHb3A1iw4t3OP_SY3_iO6SUoO_VbX3ertE7apWteAJgqDGFDIZtv069Y_c2_-kE0n5HmP0hGop2MyCktUyURVGkvx3DtWiRGuA6DtHCE7JomUTZx2go9lpjia1zSXwNy_M8ImaQK-zaZvNgN6NdU0vXkyQzFMrXGkJmQ8ZnYQmSTQ_VTrMoEUrV4zQBgchv5y6eaSm4caLB_w_1O0EiyNJyALNUvCvCHEeN9XGw9rgPJfgoz2A-UTYYGg"
    ]
}

TASK [addons : 取Dashboard只读用户令牌] ***********************************************************************************************************************************
changed: [localhost]

TASK [addons : Kubernetes Dashboard登录信息] ***************************************************************************************************************************
ok: [localhost] => {
    "readonly.stdout_lines": [
        "访问地址--->https://172.21.0.31:32020 or https://monitor.yufuid.net/dashboard/",
        "令牌内容--->eyJhbGciOiJSUzI1NiIsImtpZCI6IkVtYjJpbkkxQjRYZENQRkFKak01b0x2ZTJWUlAyLUlCRnROYUl0a1hGd0UifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi12aWV3b25seS10b2tlbi1yN3h2eiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJhZG1pbi12aWV3b25seSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImFmYTQ3MmU5LTg2ZjItNDkwMC1hMTNjLWU3YThhMmJhNmQ4NiIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbi12aWV3b25seSJ9.MQpXmOEz1SFxrzwKR4-pdabFOogMFCfRIZvLlykx8GrPpUjjTSAVartTL1ksReXJORY5P3zsPwUTuSPXKCsX1DK-pTe3-P4jxXzQh4CTZn2IZtEF28G_5JRuIxX9rtDziVMeMXQ1SLv2yOO3O0nFclN-m5REfR3CE_RMfStET3rSscbP9emmNS4pQCD0NvNDADOxdaw8yFBOkJk1-omOnPyuUMhizCDY2CyXTRV5K7bDUup1D6WYpA1bsMx_1khRAdhrZZFGP5UNJgDvxiF4jpdnMF-vYZpkF1nA1gwgYu4HNL7PylG_5IkPkbOKn0-bdum-kGa1C8ftsCDD1PAnKg"
    ]
}

TASK [addons : 准备ingress-nginx-controller的部署文件] ********************************************************************************************************************
changed: [localhost]

TASK [addons : check_label] ****************************************************************************************************************************************
fatal: [localhost]: FAILED! => {"changed": true, "cmd": " /opt/iks/bin/kubectl get no 172.21.0.31 --show-labels|grep 'ingressproxy=true'; /opt/iks/bin/kubectl get no 172.21.0.35 --show-labels|grep 'ingressproxy=true'; /opt/iks/bin/kubectl get no 172.21.0.41 --show-labels|grep 'ingressproxy=true';", "delta": "0:00:00.111756", "end": "2022-12-21 14:18:40.458083", "msg": "non-zero return code", "rc": 1, "start": "2022-12-21 14:18:40.346327", "stderr": "", "stderr_lines": [], "stdout": "", "stdout_lines": []}
...ignoring

TASK [addons : ingress-nginx-controller 标签] ************************************************************************************************************************
changed: [localhost]

TASK [addons : 创建ingress-nginx-controller部署] ***********************************************************************************************************************
changed: [localhost]
FAILED - RETRYING: 轮询等待 nginx-ingress-controller 运行 (24 retries left).

TASK [addons : 轮询等待 nginx-ingress-controller 运行] *******************************************************************************************************************
changed: [localhost]

TASK [addons : 获取是否已创建命名空间monitoring] ******************************************************************************************************************************
changed: [localhost]

TASK [addons : 创建命名空间monitoring] ***********************************************************************************************************************************
changed: [localhost]

TASK [addons : get etcd-client-cert info] **************************************************************************************************************************
changed: [localhost]

TASK [addons : 创建etcd-client 证书请求] *********************************************************************************************************************************
changed: [localhost]

TASK [addons : 创建 etcd-client证书和私钥] ********************************************************************************************************************************
changed: [localhost]

TASK [addons : 创建 etcd-client-cert] ********************************************************************************************************************************
changed: [localhost]

TASK [addons : 注册变量 K8S_VER] ***************************************************************************************************************************************
changed: [localhost]

TASK [addons : 创建 prom chart 个性化设置] ********************************************************************************************************************************
changed: [localhost]

TASK [addons : 拷贝prom-pv.yaml kube-prometheus-stack] ***************************************************************************************************************
changed: [localhost] => (item=prom-pv.yaml)
changed: [localhost] => (item=iks-dashboard01.yaml)
changed: [localhost] => (item=iks-dashboard02.yaml)
changed: [localhost] => (item=elasticsearch-exporter.yaml)
changed: [localhost] => (item=redis-exporter.yaml)
changed: [localhost] => (item=prometheus-blackbox-exporter-7.0.1.tgz)
changed: [localhost] => (item=prometheus-elasticsearch-exporter-4.15.0.tgz)
changed: [localhost] => (item=prometheus-redis-exporter-5.1.0.tgz)
changed: [localhost] => (item=kube-prometheus-stack-40.1.0.tgz)

TASK [addons : 获取是否已打标签] *******************************************************************************************************************************************
changed: [localhost]

TASK [addons : 获取是否已创建pv] ******************************************************************************************************************************************
changed: [localhost]

TASK [addons : 创建pv] ***********************************************************************************************************************************************
changed: [localhost]

TASK [addons : 安装blackbox-exporter] ********************************************************************************************************************************
changed: [localhost]

TASK [addons : helm 创建 kube-prometheus-stack 40.1.0] ***************************************************************************************************************
fatal: [localhost]: FAILED! => {"changed": true, "cmd": "/opt/iks/bin/helm upgrade --install -n monitoring prometheus -f /etc/iks/cluster/yaml/prometheus-values.yaml /etc/iks/cluster/yaml/kube-prometheus-stack-40.1.0.tgz", "delta": "0:00:12.198209", "end": "2022-12-21 14:19:03.446938", "msg": "non-zero return code", "rc": 1, "start": "2022-12-21 14:18:51.248729", "stderr": "WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /root/.kube/config\nWARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /root/.kube/config\nError: Internal error occurred: failed calling webhook \"validate.nginx.ingress.kubernetes.io\": failed to call webhook: Post \"https://ingress-nginx-controller-admission.ingress-nginx.svc:443/networking/v1/ingresses?timeout=10s\": no endpoints available for service \"ingress-nginx-controller-admission\"", "stderr_lines": ["WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /root/.kube/config", "WARNING: Kubernetes configuration file is world-readable. This is insecure. Location: /root/.kube/config", "Error: Internal error occurred: failed calling webhook \"validate.nginx.ingress.kubernetes.io\": failed to call webhook: Post \"https://ingress-nginx-controller-admission.ingress-nginx.svc:443/networking/v1/ingresses?timeout=10s\": no endpoints available for service \"ingress-nginx-controller-admission\""], "stdout": "Release \"prometheus\" does not exist. Installing it now.", "stdout_lines": ["Release \"prometheus\" does not exist. Installing it now."]}

PLAY RECAP *********************************************************************************************************************************************************
172.21.0.31                : ok=155  changed=122  unreachable=0    failed=0    skipped=59   rescued=0    ignored=6
172.21.0.35                : ok=143  changed=113  unreachable=0    failed=0    skipped=61   rescued=0    ignored=6
172.21.0.41                : ok=143  changed=112  unreachable=0    failed=0    skipped=61   rescued=0    ignored=6
localhost                  : ok=64   changed=60   unreachable=0    failed=1    skipped=2    rescued=0    ignored=3
